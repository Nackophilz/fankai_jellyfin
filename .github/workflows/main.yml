name: AIO Plugin Fankai (Jellyfin & Emby)

on:
  push:
    branches:
      - main
    paths:
      - 'Jellyfin.Plugin.Fankai/**'
      - '!Jellyfin.Plugin.Fankai/**/*.md'

jobs:
  build-release-and-update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration du SDK .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Extraction de la version du plugin
        id: get_version
        run: |
          CSPROJ_PATH="Jellyfin.Plugin.Fankai/Jellyfin.Plugin.Fankai.csproj"
          if [ ! -f "$CSPROJ_PATH" ]; then
            echo "Erreur : $CSPROJ_PATH non trouvé."
            exit 1
          fi
          VERSION=$(grep '<Version>' "$CSPROJ_PATH" | sed -e 's/.*<Version>\(.*\)<\/Version>.*/\1/' | tr -d '[:space:]')
          echo "PLUGIN_VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version détectée : $VERSION"

      # --- BLOC JELLYFIN ---

      - name: [Jellyfin] Compilation
        id: build_jellyfin
        run: |
          PROJECT_PATH="Jellyfin.Plugin.Fankai/Jellyfin.Plugin.Fankai.csproj"
          OUT_DIR="./publish_jellyfin"
          mkdir -p "$OUT_DIR"
          
          dotnet publish "$PROJECT_PATH" --configuration Release --output "$OUT_DIR"
          echo "PUBLISH_DIR=$OUT_DIR" >> $GITHUB_OUTPUT

      - name: [Jellyfin] Création du ZIP
        id: zip_jellyfin
        run: |
          ZIP_NAME="Jellyfin.Plugin.Fankai.zip"
          PUB_DIR="${{ steps.build_jellyfin.outputs.PUBLISH_DIR }}"
          DLL_NAME="Jellyfin.Plugin.Fankai.dll"
          
          # Vérif
          if [ ! -f "$PUB_DIR/$DLL_NAME" ]; then
            echo "::error::DLL Jellyfin introuvable !"
            exit 1
          fi
          
          # Zip (j9 = compression max, j = junk paths/flat structure)
          (cd "$PUB_DIR" && zip -j9 "../$ZIP_NAME" "$DLL_NAME")
          
          echo "ZIP_PATH=./$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_OUTPUT

      # --- BLOC EMBY ---

      - name: [Emby] Compilation
        id: build_emby
        run: |
          PROJECT_PATH="Jellyfin.Plugin.Fankai/Jellyfin.Plugin.Fankai.csproj"
          OUT_DIR="./publish_emby"
          mkdir -p "$OUT_DIR"
          
          # Note l'argument --configuration Emby
          dotnet publish "$PROJECT_PATH" --configuration Emby --output "$OUT_DIR"
          echo "PUBLISH_DIR=$OUT_DIR" >> $GITHUB_OUTPUT

      - name: [Emby] Création du ZIP
        id: zip_emby
        run: |
          # Nom différent pour ne pas écraser celui de Jellyfin
          ZIP_NAME="Jellyfin.Plugin.Fankai.Emby.zip"
          PUB_DIR="${{ steps.build_emby.outputs.PUBLISH_DIR }}"
          DLL_NAME="Jellyfin.Plugin.Fankai.dll"
          
          if [ ! -f "$PUB_DIR/$DLL_NAME" ]; then
            echo "::error::DLL Emby introuvable !"
            exit 1
          fi
          
          (cd "$PUB_DIR" && zip -j9 "../$ZIP_NAME" "$DLL_NAME")
          
          echo "ZIP_PATH=./$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_OUTPUT

      # --- COMMUN ---

      - name: Calcul des Checksums
        id: checksums
        run: |
          ZIP_JF="${{ steps.zip_jellyfin.outputs.ZIP_PATH }}"
          ZIP_EMBY="${{ steps.zip_emby.outputs.ZIP_PATH }}"
          
          SUM_JF=$(md5sum "$ZIP_JF" | awk '{ print $1 }')
          SUM_EMBY=$(md5sum "$ZIP_EMBY" | awk '{ print $1 }')
          
          echo "JF_CHECKSUM=$SUM_JF" >> $GITHUB_OUTPUT
          echo "EMBY_CHECKSUM=$SUM_EMBY" >> $GITHUB_OUTPUT
          
          echo "Checksum Jellyfin : $SUM_JF"
          echo "Checksum Emby : $SUM_EMBY"

      - name: Récupération info commit & date
        id: meta
        run: |
          MSG=$(git log -1 --pretty=%B)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          echo "ISO_TIMESTAMP=$DATE" >> $GITHUB_OUTPUT

      - name: Création Release GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.PLUGIN_VERSION }}
          name: Release v${{ steps.get_version.outputs.PLUGIN_VERSION }}
          body: |
            ${{ steps.meta.outputs.CHANGELOG }}
            ---
            ### Checksums (MD5)
            - **Jellyfin**: `${{ steps.checksums.outputs.JF_CHECKSUM }}`
            - **Emby**: `${{ steps.checksums.outputs.EMBY_CHECKSUM }}`
          files: |
            ${{ steps.zip_jellyfin.outputs.ZIP_PATH }}
            ${{ steps.zip_emby.outputs.ZIP_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- MISE A JOUR DES MANIFESTES ---

      - name: Mise à jour des Manifests (JSON)
        run: |
          VERSION="${{ steps.get_version.outputs.PLUGIN_VERSION }}"
          LOG="${{ steps.meta.outputs.CHANGELOG }}"
          TIME="${{ steps.meta.outputs.ISO_TIMESTAMP }}"
          REPO="${{ github.repository }}"
          
          # --- JELLYFIN ---
          # Cible ABI Jellyfin 10.9
          ABI_JF="10.9.0.0"
          ZIP_JF_NAME="${{ steps.zip_jellyfin.outputs.ZIP_NAME }}"
          SUM_JF="${{ steps.checksums.outputs.JF_CHECKSUM }}"
          URL_JF="https://github.com/$REPO/releases/download/v$VERSION/$ZIP_JF_NAME"
          
          # Mise à jour manifest.json
          if [ -f manifest.json ]; then
            NEW_JF=$(jq -n \
              --arg v "$VERSION" \
              --arg c "$LOG" \
              --arg t "$ABI_JF" \
              --arg u "$URL_JF" \
              --arg s "$SUM_JF" \
              --arg d "$TIME" \
              '{version: $v, changelog: $c, targetAbi: $t, sourceUrl: $u, checksum: $s, timestamp: $d}')
            
            TEMP_JF=$(jq --argjson new "$NEW_JF" '.[0].versions = [$new] + .[0].versions' manifest.json)
            echo "$TEMP_JF" > manifest.json
            echo "✅ manifest.json (Jellyfin) mis à jour."
          else
            echo "⚠️ manifest.json introuvable !"
          fi

          # --- EMBY ---
          # Cible ABI Emby 4.8
          ABI_EMBY="4.8.0.0"
          ZIP_EMBY_NAME="${{ steps.zip_emby.outputs.ZIP_NAME }}"
          SUM_EMBY="${{ steps.checksums.outputs.EMBY_CHECKSUM }}"
          URL_EMBY="https://github.com/$REPO/releases/download/v$VERSION/$ZIP_EMBY_NAME"
          
          # Mise à jour emby_manifest.json
          # On vérifie s'il existe, sinon on copie la structure de base du manifest Jellyfin
          if [ ! -f emby_manifest.json ] && [ -f manifest.json ]; then
             echo "emby_manifest.json introuvable, création à partir de manifest.json..."
             cp manifest.json emby_manifest.json
             # On vide les versions pour recommencer propre si création
             jq '.[0].versions = []' emby_manifest.json > emby_manifest.tmp && mv emby_manifest.tmp emby_manifest.json
          fi

          if [ -f emby_manifest.json ]; then
            NEW_EMBY=$(jq -n \
              --arg v "$VERSION" \
              --arg c "$LOG" \
              --arg t "$ABI_EMBY" \
              --arg u "$URL_EMBY" \
              --arg s "$SUM_EMBY" \
              --arg d "$TIME" \
              '{version: $v, changelog: $c, targetAbi: $t, sourceUrl: $u, checksum: $s, timestamp: $d}')
            
            TEMP_EMBY=$(jq --argjson new "$NEW_EMBY" '.[0].versions = [$new] + .[0].versions' emby_manifest.json)
            echo "$TEMP_EMBY" > emby_manifest.json
            echo "✅ emby_manifest.json mis à jour."
          else
            echo "⚠️ Impossible de créer ou trouver emby_manifest.json"
          fi

      - name: Commit et Push des changements
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add manifest.json emby_manifest.json
          
          if git diff --staged --quiet; then
            echo "Rien à commiter."
          else
            git commit -m "Mise à jour manifests v${{ steps.get_version.outputs.PLUGIN_VERSION }} [skip ci]"
            git push
          fi